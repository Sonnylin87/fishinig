import { WebSocketServer } from 'ws';
import { createServer } from 'http';

const server = createServer();
const wss = new WebSocketServer({ server });

const players = new Map();

wss.on('connection', (ws) => {
  const playerId = Date.now();
  players.set(playerId, { 
    ws, 
    money: 100, 
    hand: [
      { id: 1, type: 'rod', name: '基本釣竿', level: 1 },
      { id: 2, type: 'bait', name: '基本餌料', level: 1 }
    ], 
    caughtFish: [] 
  });

  ws.on('message', (message) => {
    const data = JSON.parse(message);
    handlePlayerAction(playerId, data);
  });

  ws.on('close', () => {
    players.delete(playerId);
  });
});

function handlePlayerAction(playerId, action) {
  const player = players.get(playerId);
  if (!player) return;

  switch (action.type) {
    case 'FISH':
      const rod = player.hand.find(item => item.type === 'rod');
      const bait = player.hand.find(item => item.type === 'bait');
      const baseValue = Math.floor(Math.random() * 10) + 1;
      const fishValue = baseValue * (rod.level + bait.level);
      const fish = {
        id: Date.now(),
        name: getFishName(fishValue),
        value: fishValue
      };
      player.caughtFish.push(fish);
      player.ws.send(JSON.stringify({ type: 'FISH_CAUGHT', fish }));
      broadcastToOthers(playerId, { type: 'OPPONENT_CAUGHT_FISH', fish });
      break;
    case 'BUY':
      if (player.money >= action.item.cost) {
        player.money -= action.item.cost;
        player.hand.push(action.item);
        player.ws.send(JSON.stringify({ type: 'ITEM_BOUGHT', item: action.item }));
      }
      break;
    case 'SELL':
      const fishIndex = player.caughtFish.findIndex(f => f.id === action.fishId);
      if (fishIndex !== -1) {
        const fish = player.caughtFish[fishIndex];
        player.caughtFish.splice(fishIndex, 1);
        const sellValue = fish.value * action.diceResult;
        player.money += sellValue;
        player.ws.send(JSON.stringify({ type: 'FISH_SOLD', amount: sellValue }));
      }
      break;
  }

  checkWinCondition(playerId);
}

function getFishName(value) {
  if (value < 10) return '小魚';
  if (value < 20) return '中魚';
  if (value < 30) return '大魚';
  return '稀有魚';
}

function broadcastToOthers(senderId, message) {
  for (const [id, player] of players.entries()) {
    if (id !== senderId) {
      player.ws.send(JSON.stringify(message));
    }
  }
}

function checkWinCondition(playerId) {
  const player = players.get(playerId);
  const bestFish = player.caughtFish.reduce((best, fish) => fish.value > best.value ? fish : best, { value: 0 });

  if (bestFish.value >= 50) {
    player.ws.send(JSON.stringify({ type: 'GAME_WON' }));
    broadcastToOthers(playerId, { type: 'GAME_LOST' });
  }
}

server.listen(3001, () => {
  console.log('WebSocket server is running on port 3001');
});
